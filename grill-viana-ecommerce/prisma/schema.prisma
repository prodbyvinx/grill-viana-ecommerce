generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// -------- Enums --------
enum UserRole {
  ADMIN
  CUSTOMER
}

enum Material {
  INOX
  GALVANIZADO
}

enum AddressType {
  SHIPPING
  BILLING
}

enum OrderStatus {
  PENDING
  PAID
  REFUNDED
  CANCELED
}

enum PaymentStatus {
  PENDING
  APPROVED
  AUTHORIZED
  IN_PROCESS
  IN_MEDIATION
  REJECTED
  CANCELLED
  REFUNDED
  CHARGED_BACK
}

enum PaymentProvider {
  MERCADOPAGO
}

enum WebhookProvider {
  MERCADOPAGO
  BLING
}

enum WebhookStatus {
  RECEIVED
  PROCESSED
  ERROR
}

enum InventoryMovementType {
  IN
  OUT
  ADJUSTMENT
}

enum CartStatus {
  ACTIVE
  COMPLETED
  ABANDONED
}

enum CouponType {
  PERCENT
  FIXED
}

enum DocumentType {
  CPF
  CNPJ
}

// -------- Core Auth --------
model User {
  id           Int      @id @default(autoincrement())
  name         String?
  email        String   @unique
  passwordHash String
  role         UserRole @default(CUSTOMER)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  orders    Order[]
  addresses Address[]
  carts     Cart[]
}

// -------- Catalog --------
model Category {
  id        Int       @id @default(autoincrement())
  name      String
  slug      String    @default("sem-slug")
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  products  Product[]
}

model Product {
  id          Int     @id @default(autoincrement())
  name        String
  slug        String? @unique
  sku         String  @unique
  ncm         String?
  description String
  priceCents  Int     @default(0)
  stockTotal  Int     @default(0)
  widthCm     Int?
  heightCm    Int?
  depthCm     Int?
  material    String? @default("")
  isActive    Boolean @default(true)

  // relação com Category (opcional)
  categoryId Int?
  category   Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  images     ProductImage[]
  variants   ProductVariant[]
  prices     Price[]
  inventory  InventoryMovement[]
  orderItems OrderItem[]
  cartItems  CartItem[]

  rating      Float @default(0)
  ratingCount Int   @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
}

model ProductImage {
  id       Int     @id @default(autoincrement())
  url      String
  alt      String?
  position Int     @default(0)

  productId Int
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId, position])
}

model ProductVariant {
  id          String   @id @default(cuid())
  productId   Int
  product     Product  @relation(fields: [productId], references: [id])
  sku         String   @unique
  name        String?
  priceCents  Int
  stockTotal  Int      @default(0)
  weightGrams Int?
  widthMm     Int?
  heightMm    Int?
  depthMm     Int?
  attributes  Json?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  orderItems OrderItem[]
  inventory  InventoryMovement[]
  Price      Price[]
  CartItem   CartItem[]

  @@index([productId])
}

model Price {
  id          String          @id @default(cuid())
  productId   Int
  product     Product         @relation(fields: [productId], references: [id])
  variantId   String?
  variant     ProductVariant? @relation(fields: [variantId], references: [id])
  amountCents Int
  currency    String          @default("BRL")
  startsAt    DateTime        @default(now())
  endsAt      DateTime?
  createdAt   DateTime        @default(now())

  @@index([productId, startsAt])
}

model InventoryMovement {
  id        String                @id @default(cuid())
  productId Int?
  variantId String?
  product   Product?              @relation(fields: [productId], references: [id])
  variant   ProductVariant?       @relation(fields: [variantId], references: [id])
  quantity  Int
  type      InventoryMovementType
  reason    String?
  orderId   String?
  order     Order?                @relation(fields: [orderId], references: [id])
  createdAt DateTime              @default(now())

  @@index([productId, variantId, createdAt])
}

// -------- Cart / Checkout --------
model Cart {
  id                   String     @id @default(cuid())
  userId               Int?
  user                 User?      @relation(fields: [userId], references: [id])
  status               CartStatus @default(ACTIVE)
  items                CartItem[]
  checkoutPreferenceId String?
  createdAt            DateTime   @default(now())
  updatedAt            DateTime   @updatedAt
}

model CartItem {
  id     String @id @default(cuid())
  cartId String
  cart   Cart   @relation(fields: [cartId], references: [id])

  productId Int
  product   Product @relation(fields: [productId], references: [id])

  variantId String?
  variant   ProductVariant? @relation(fields: [variantId], references: [id])

  quantity  Int
  unitCents Int
  createdAt DateTime @default(now())

  @@unique([cartId, productId, variantId])
}

// -------- Orders / Payments / Shipping --------
model Order {
  id          String @id @default(cuid())
  orderNumber Int    @unique @default(autoincrement())

  // Vínculo com usuário (opcional – permite guest checkout)
  userId Int?
  user   User? @relation(fields: [userId], references: [id])

  // Snapshot de cliente para NF/contato
  customerName  String?
  customerEmail String?
  customerPhone String?
  documentType  DocumentType?
  document      String?

  // Endereços (rel. nominado)
  shippingAddressId String?
  billingAddressId  String?
  shippingAddress   Address? @relation("OrderShippingAddress", fields: [shippingAddressId], references: [id])
  billingAddress    Address? @relation("OrderBillingAddress", fields: [billingAddressId], references: [id])

  // Totais
  status        String        @default("pending")
  paymentStatus PaymentStatus @default(PENDING)
  subtotalCents Int           @default(0)
  discountCents Int           @default(0)
  shippingCents Int           @default(0)
  totalCents    Int           @default(0)

  // Pagamento/Marketplace
  provider       PaymentProvider?
  externalRef    String           @unique @default("")
  mpPaymentId    String?          @unique
  mpPreferenceId String?
  mpInitPoint    String?

  // Bling / ERP
  blingOrderNumber String? @unique

  // Relations
  items    OrderItem[]
  shipping Shipping?

  metadata          Json?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  InventoryMovement InventoryMovement[]
  BlingSync         BlingSync?

  // Idempotência de webhook
  lastPaymentId String? // guarda o último paymentId processado
  payments      Payment[] // relation de pagamentos
  paymentId     Int?

  @@index([status, createdAt])
}

model OrderItem {
  id      String @id @default(cuid())
  orderId String
  order   Order  @relation(fields: [orderId], references: [id])

  productId Int?
  product   Product? @relation(fields: [productId], references: [id])

  variantId String?
  variant   ProductVariant? @relation(fields: [variantId], references: [id])

  // Snapshot
  sku        String?
  name       String
  quantity   Int
  unitCents  Int
  totalCents Int
  metadata   Json?

  @@index([orderId])
}

model Payment {
  id                String          @id @default(cuid())
  orderId           String
  order             Order           @relation(fields: [orderId], references: [id])
  provider          PaymentProvider @default(MERCADOPAGO)
  providerPaymentId String?         @unique
  status            PaymentStatus   @default(PENDING)
  amountCents       Int
  feeCents          Int?
  paidAt            DateTime?
  raw               Json?
  createdAt         DateTime        @default(now())
  WebhookEvent      WebhookEvent[]

  @@index([orderId, status])
}

model Shipping {
  id              String    @id @default(cuid())
  orderId         String    @unique
  order           Order     @relation(fields: [orderId], references: [id])
  serviceName     String?
  carrier         String?
  trackingCode    String?
  costCents       Int?
  shippedAt       DateTime?
  deliveredAt     DateTime?
  addressSnapshot Json?
}

model Address {
  id           String      @id @default(cuid())
  userId       Int?
  user         User?       @relation(fields: [userId], references: [id])
  type         AddressType
  name         String?
  phone        String?
  street       String
  number       String?
  complement   String?
  neighborhood String?
  city         String
  state        String
  country      String      @default("BR")
  zip          String
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  shippingOrders Order[] @relation("OrderShippingAddress")
  billingOrders  Order[] @relation("OrderBillingAddress")
}

// -------- ERP / Webhooks --------
model BlingSync {
  id           String    @id @default(cuid())
  orderId      String    @unique
  order        Order     @relation(fields: [orderId], references: [id])
  pedidoNumero String?   @unique
  status       String?
  lastSyncAt   DateTime?
  raw          Json?
}

model WebhookEvent {
  id               String          @id @default(cuid())
  provider         WebhookProvider
  externalId       String?
  eventType        String?
  payload          Json
  status           WebhookStatus   @default(RECEIVED)
  processedAt      DateTime?
  errorMessage     String?
  relatedPaymentId String?
  payment          Payment?        @relation(fields: [relatedPaymentId], references: [id])
  createdAt        DateTime        @default(now())

  @@index([provider, externalId])
}

// -------- Marketing --------
model Coupon {
  id         String     @id @default(cuid())
  code       String     @unique
  type       CouponType
  value      Int
  startsAt   DateTime?
  endsAt     DateTime?
  usageLimit Int?
  usedCount  Int        @default(0)
  isActive   Boolean    @default(true)
  createdAt  DateTime   @default(now())
}
